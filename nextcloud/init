## TODO Before 
## - Export Cal/TODO 
## - Backup Joplin and turn off sync 

mkdir "/mnt/ncmedia"

sudo tee -a /etc/fstab > /dev/null <<EOF
UUID=180b0135-0219-4c94-7a06-3087c4388cdf  /     ext4  errors=remount-ro  0  1
UUID=f1408ea6-59a0-11ed-bc9d-525400000001  none  swap  sw                 0  0
/dev/disk/by-id/scsi-0Linode_Volume_ncmedia /mnt/ncmedia ext4 defaults,noatime,nofail 0 2

# object storage bucket
capuk-media                                     /mnt/capuk-media  fuse.s3fs  _netdev,allow_other,use_path_request_style,url=https://us-iad-1.linodeobjects.com/  0  0
EOF

sudo mount -a
#mount "/dev/disk/by-id/scsi-0Linode_Volume_ncmedia" "/mnt/ncmedia"
sudo chown -R www-data:www-data /mnt/ncmedia
sudo apt update -y && sudo apt install -y borgbackup
sudo docker exec --user www-data -it nextcloud-aio-nextcloud php occ config:app:set dav rateLimitCalendarCreation --type=integer --value=1000
sudo docker exec --user www-data -it nextcloud-aio-nextcloud php occ config:app:set dav rateLimitPeriodCalendarCreation --type=integer --value=180000
sudo docker exec --user www-data -it nextcloud-aio-nextcloud php occ config:app:set dav maximumCalendarsSubscriptions --type=integer --value=5000
sudo docker exec --user www-data -it nextcloud-aio-nextcloud php occ maintenance:repair --include-expensive
sudo docker exec --user www-data -it nextcloud-aio-nextcloud php occ files_external:enabled
sudo docker exec --user www-data -it nextcloud-aio-nextcloud php occ files_external
sudo docker exec --user www-data -it nextcloud-aio-nextcloud php occ files_external enabled
sudo docker exec --user www-data -it nextcloud-aio-nextcloud php occ config:app:set files_external allow_user_mounting --value="yes"
sudo docker exec --user www-data -it nextcloud-aio-nextcloud php occ files:cleanup

## setup s3fs
## TODO: Setup /etc/passwd-s3fs file from UDF echo "ACCESS_KEY:SECRET_KEY" | sudo tee /etc/passwd-s3fs
#mkdir "/mnt/capuk-media"
#sudo apt install -y s3fs
#s3fs -d -d -f -o f2 -o curldbg capuk-media /mnt/capuk-media -o url="https
://us-iad-1.linodeobjects.com" -o endpoint=us-iad -o passwd_file=/etc/passwd-s3f
s


### Post Configure
## - Setup external storage (on disk) 
## - Setup external storage (s3) 

## local /mnt/ncmedia > ncmedia
# 1. Create external storage mount (local backend, no auth)
sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:create ncmedia local null::null

# 2. Configure the path to the local directory
sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:config ncmedia path /mnt/ncmedia

# 3. Assign access to the user 'admin'
sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:applicable ncmedia user admin

# 4. Optional: Enable external storage app if not already enabled
sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ app:enable files_external

### s3 capuk-media
# 1. Create the external storage mount
sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:create capuk-media amazons3 accesskey::accesskey

# 2. Configure the bucket, region, and endpoint
sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:config capuk-media bucket capuk-media

sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:config capuk-media hostname us-iad-1.linodeobjects.com

sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:config capuk-media port 443

sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:config capuk-media use_ssl true

sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:config capuk-media region us-east-1

# 3. Add credentials
sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:config capuk-media key YOUR_ACCESS_KEY

sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:config capuk-media secret YOUR_SECRET_KEY

# 4. Make it available to the user 'capuk'
sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:applicable capuk-media user capuk

## ensure storage app is enabled 
sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ app:enable files_external
sudo docker exec --user www-data -it nextcloud-aio-nextcloud \
php occ files_external:list
